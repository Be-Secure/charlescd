{"ast":null,"code":"import _slicedToArray from\"/Users/ricardobasilio/projects/charlescd/ui/packages/new-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _regeneratorRuntime from\"/Users/ricardobasilio/projects/charlescd/ui/packages/new-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/ricardobasilio/projects/charlescd/ui/packages/new-ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{useEffect,useState,useCallback,useRef}from'react';import{HTTP_STATUS}from'core/enums/HttpStatus';import{renewToken}from'../auth';import{getRefreshToken}from'core/utils/auth';import{redirectToLegacy}from'core/utils/routes';import routes from'core/constants/routes';var renewTokenByCb=function renewTokenByCb(fn){return fn().catch(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(error){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(HTTP_STATUS.unauthorized===error.status)){_context.next=13;break;}_context.prev=1;_context.next=4;return renewToken(getRefreshToken())({});case 4:return _context.abrupt(\"return\",fn());case 7:_context.prev=7;_context.t0=_context[\"catch\"](1);redirectToLegacy(routes.login);return _context.abrupt(\"return\",_context.t0);case 11:_context.next=14;break;case 13:return _context.abrupt(\"return\",Promise.reject(error));case 14:case\"end\":return _context.stop();}}},_callee,null,[[1,7]]);}));return function(_x){return _ref.apply(this,arguments);};}());};export var useFetch=function useFetch(req){var _useState=useState(),_useState2=_slicedToArray(_useState,2),response=_useState2[0],setResponse=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),error=_useState4[0],setError=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),loading=_useState6[0],setLoading=_useState6[1];var mounted=useRef(true);var trigger=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _len,args,_key,_response,data,_args2=arguments;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:for(_len=_args2.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=_args2[_key];}setLoading(true);_context2.prev=2;_context2.next=5;return renewTokenByCb(function(){return req.apply(void 0,args)({});});case 5:_response=_context2.sent;_context2.next=8;return _response.json();case 8:data=_context2.sent;if(mounted.current)setResponse(data);_context2.next=15;break;case 12:_context2.prev=12;_context2.t0=_context2[\"catch\"](2);if(mounted.current)setError(_context2.t0);case 15:_context2.prev=15;if(mounted.current)setLoading(false);return _context2.finish(15);case 18:case\"end\":return _context2.stop();}}},_callee2,null,[[2,12,15,18]]);})),[req,mounted]);useEffect(function(){return function(){return mounted.current=false;};},[]);return[{response:response,error:error,loading:loading},trigger];};","map":{"version":3,"sources":["/Users/ricardobasilio/projects/charlescd/ui/packages/new-ui/src/core/providers/base/hooks.ts"],"names":["useEffect","useState","useCallback","useRef","HTTP_STATUS","renewToken","getRefreshToken","redirectToLegacy","routes","renewTokenByCb","fn","catch","error","unauthorized","status","login","Promise","reject","useFetch","req","response","setResponse","setError","loading","setLoading","mounted","trigger","args","json","data","current"],"mappings":"mhBAAA,OAASA,SAAT,CAAoBC,QAApB,CAA8BC,WAA9B,CAA2CC,MAA3C,KAAyD,OAAzD,CACA,OAASC,WAAT,KAA4B,uBAA5B,CACA,OAASC,UAAT,KAA2B,SAA3B,CACA,OAASC,eAAT,KAAgC,iBAAhC,CACA,OAASC,gBAAT,KAAiC,mBAAjC,CACA,MAAOC,CAAAA,MAAP,KAAmB,uBAAnB,CAQA,GAAMC,CAAAA,cAAc,CAAG,QAAjBA,CAAAA,cAAiB,CAACC,EAAD,QACrBA,CAAAA,EAAE,GAAGC,KAAL,0FAAW,iBAAOC,KAAP,uHACLR,WAAW,CAACS,YAAZ,GAA6BD,KAAK,CAACE,MAD9B,iEAGCT,CAAAA,UAAU,CAACC,eAAe,EAAhB,CAAV,CAA8B,EAA9B,CAHD,wCAIEI,EAAE,EAJJ,0DAMLH,gBAAgB,CAACC,MAAM,CAACO,KAAR,CAAhB,CANK,oHAUAC,OAAO,CAACC,MAAR,CAAeL,KAAf,CAVA,sEAAX,+DADqB,EAAvB,CAeA,MAAO,IAAMM,CAAAA,QAAQ,CAAG,QAAXA,CAAAA,QAAW,CACtBC,GADsB,CAE2B,eACjBlB,QAAQ,EADS,wCAC1CmB,QAD0C,eAChCC,WADgC,8BAEvBpB,QAAQ,CAAW,IAAX,CAFe,yCAE1CW,KAF0C,eAEnCU,QAFmC,8BAGnBrB,QAAQ,CAAC,KAAD,CAHW,yCAG1CsB,OAH0C,eAGjCC,UAHiC,eAIjD,GAAMC,CAAAA,OAAO,CAAGtB,MAAM,CAAC,IAAD,CAAtB,CAEA,GAAMuB,CAAAA,OAAO,CAAGxB,WAAW,sEACzB,kNAAUyB,IAAV,0CAAUA,IAAV,qBACEH,UAAU,CAAC,IAAD,CAAV,CADF,wCAG2Bf,CAAAA,cAAc,CAAC,iBAAMU,CAAAA,GAAG,MAAH,QAAOQ,IAAP,EAAa,EAAb,CAAN,EAAD,CAHzC,QAGUP,SAHV,uCAIuBA,CAAAA,SAAQ,CAACQ,IAAT,EAJvB,QAIUC,IAJV,gBAMI,GAAIJ,OAAO,CAACK,OAAZ,CAAqBT,WAAW,CAACQ,IAAD,CAAX,CANzB,qFAQI,GAAIJ,OAAO,CAACK,OAAZ,CAAqBR,QAAQ,cAAR,CARzB,0BAUI,GAAIG,OAAO,CAACK,OAAZ,CAAqBN,UAAU,CAAC,KAAD,CAAV,CAVzB,yGADyB,GAczB,CAACL,GAAD,CAAMM,OAAN,CAdyB,CAA3B,CAiBAzB,SAAS,CAAC,UAAM,CACd,MAAO,kBAAOyB,CAAAA,OAAO,CAACK,OAAR,CAAkB,KAAzB,EAAP,CACD,CAFQ,CAEN,EAFM,CAAT,CAIA,MAAO,CAAC,CAAEV,QAAQ,CAARA,QAAF,CAAYR,KAAK,CAALA,KAAZ,CAAmBW,OAAO,CAAPA,OAAnB,CAAD,CAA+BG,OAA/B,CAAP,CACD,CA9BM","sourcesContent":["import { useEffect, useState, useCallback, useRef } from 'react';\nimport { HTTP_STATUS } from 'core/enums/HttpStatus';\nimport { renewToken } from '../auth';\nimport { getRefreshToken } from 'core/utils/auth';\nimport { redirectToLegacy } from 'core/utils/routes';\nimport routes from 'core/constants/routes';\n\ninterface FetchData<T> {\n  response: T;\n  error: Response;\n  loading: boolean;\n}\n\nconst renewTokenByCb = (fn: () => Promise<Response>) =>\n  fn().catch(async (error: Response) => {\n    if (HTTP_STATUS.unauthorized === error.status) {\n      try {\n        await renewToken(getRefreshToken())({});\n        return fn();\n      } catch (error) {\n        redirectToLegacy(routes.login);\n        return error;\n      }\n    } else {\n      return Promise.reject(error);\n    }\n  });\n\nexport const useFetch = <T>(\n  req: (...args: unknown[]) => (options: RequestInit) => Promise<Response>\n): [FetchData<T>, (...args: unknown[]) => void] => {\n  const [response, setResponse] = useState<T>();\n  const [error, setError] = useState<Response>(null);\n  const [loading, setLoading] = useState(false);\n  const mounted = useRef(true);\n\n  const trigger = useCallback(\n    async (...args: unknown[]) => {\n      setLoading(true);\n      try {\n        const response = await renewTokenByCb(() => req(...args)({}));\n        const data = await response.json();\n\n        if (mounted.current) setResponse(data);\n      } catch (error) {\n        if (mounted.current) setError(error);\n      } finally {\n        if (mounted.current) setLoading(false);\n      }\n    },\n    [req, mounted]\n  );\n\n  useEffect(() => {\n    return () => (mounted.current = false);\n  }, []);\n\n  return [{ response, error, loading }, trigger];\n};\n"]},"metadata":{},"sourceType":"module"}